<script src="./js/libs/jquery-1.11.3.min.js"></script>
<script src="https://cdn.mlkcca.com/v2.0.0/milkcocoa.js"></script>
<script src="./js/function.js"></script>
{% if page.page == 'sp' %}
<script>
$(function(){
	var output = document.getElementById('output');
	var ball_dom = document.getElementById('Ball');

	var _self = this;

	// app_idは自分のものに書き換えてください
	var milkcocoa = new MilkCocoa("maxigxffjt7.mlkcca.com");
	var ds = milkcocoa.dataStore('gravity');
	
	// randomでカラー生成
	function colorGen(){
		// 参考:http://www.peko-step.com/tool/hsvrgb.html
		// RGB変数
		var _r,_g,_b;
		// HSVの値ランダム生成
		var _h = Math.floor(Math.random()*360);		// 色相
		var _s = Math.floor(Math.random()*255);		// 彩度
		var _v = Math.floor(Math.random()*128)+127;	// 明度

		// HSVの値からRGBの最大値、最小値算出
		var _rgb_max = _v;
		var _rgb_min = Math.floor(_rgb_max - ((_s/255)*_rgb_max));

		// Hの値によって算出方法変更
		if(_h >= 0 && _h < 60){
			_r = _rgb_max;
			_g = (_h / 60)*(_rgb_max - _rgb_min) + _rgb_min;
			_b = _rgb_min;
		} else if(_h >= 60 && _h < 120){
			_r = ((120 - _h)/60)*(_rgb_max - _rgb_min) + _rgb_min;
			_g = _rgb_max;
			_b = _rgb_min;
		} else if(_h >= 120 && _h < 180){
			_r = _rgb_min;
			_g = _rgb_max;
			_b = ((_h - 120)/60)*(_rgb_max - _rgb_min) + _rgb_min;
		} else if(_h >= 180 && _h < 240){
			_r = _rgb_min;
			_g = ((240 - _h)/60)*(_rgb_max - _rgb_min) + _rgb_min;
			_b = _rgb_max;
		} else if(_h >= 240 && _h < 300){
			_r = ((_h - 240)/60)*(_rgb_max - _rgb_min) + _rgb_min;
			_g = _rgb_min;
			_b = _rgb_max;
		} else if(_h >= 300 && _h < 360){
			_r = _rgb_max;
			_g = _rgb_min;
			_b = ((360 - _h)/60)*(_rgb_max - _rgb_min) + _rgb_min;
		}

		var _r_str = (Math.floor(_r).toString(16).length < 2) ? "0"+Math.floor(_r).toString(16) : Math.floor(_r).toString(16);
		var _g_str = (Math.floor(_g).toString(16).length < 2) ? "0"+Math.floor(_g).toString(16) : Math.floor(_g).toString(16);
		var _b_str = (Math.floor(_b).toString(16).length < 2) ? "0"+Math.floor(_b).toString(16) : Math.floor(_b).toString(16);

		return '#'+_r_str+_g_str+_b_str; 
	}

	// ボール生成
	var generateBall = function (){
		var _color = colorGen();
		console.log(_color);
		var _ball = new Ball(ball_dom,
												$('#Body').outerWidth()*0.5,
												$('#Body').outerHeight()*0.5,
												0,
												0,
												60,
												_color);
		_ball.setRect($('#Body').outerWidth(),$('#Body').outerHeight());
		$('#Ball').css({
			'left':_ball.posX+'px',
			'top':_ball.posY+'px',
			'width':_ball.size+'px',
			'height':_ball.size+'px',
			'border': '2px solid ' + _ball.color,
			'box-shadow': '0 0 50px ' + _ball.color +' inset'
		});
		_ball.start();
		_ball.addEventListener("sended", sendBall );
	}
	generateBall();

	// ボールをclientに送る
	function sendBall(e){
		var ball = e.currentTarget;
		ds.send({
			size: ball.size,
			posX: ball.posX,
			posY: ball.posY,
			spdX: ball.spdX,
			spdY: ball.spdY,
			color: ball.color
		});
		ball.removeEventListener("sended",sendBall);
		ball = null;
		$('#Ball').remove();
		$('#output').append('<div id="Ball" class="ball"></div>');
		ball_dom = $('#Ball').get(0);
		generateBall();
	}

	/*
	window.addEventListener('devicemotion', function(e){
		gravity = e.accelerationIncludingGravity;

		output.innerHTML
		= 'x方向: '+gravity.x
		+ '<br>y方向: '+gravity.y;

		sendModeFromGravityValue(gravity);

	},true);


	function sendModeFromGravityValue(g){

		// 絶対値を取得
		var x = Math.sqrt(g.x * g.x);
		var y = Math.sqrt(g.y * g.y);

		// portrait -> landscape
		if(currentMode === 'portrait' && x > 8.5 && y < 1.5){
			currentMode = 'landscape';
			ds.send({mode: currentMode});
		}

		// landscape -> portrait
		if(currentMode === 'landscape' && x < 1.5 && y > 8.5){
			currentMode = 'portrait';
			ds.send({mode: currentMode});
		}
	}
	*/
});
</script>
{% else %}
<script>
$(function(){

	// Ballクラス格納用array
	var ball_list = [];

	var image = document.getElementById('image');

	// app_idは自分のものに書き換えてください
	var milkcocoa = new MilkCocoa("maxigxffjt7.mlkcca.com");
	var ds = milkcocoa.dataStore('gravity');

	ds.on('send', recieveBall);

	function recieveBall(sent){
		$('#output').append('<div id="Ball'+ball_list.length+'" class="ball"></div>');
		var _ball_dom = $('#Ball'+ball_list.length).get(0);

		if(sent.value.mode === 'portrait'){
			image.className = '';
		}
		
		var _ball = new Ball(_ball_dom,
													sent.value.posX,
													sent.value.posY+$('#Body').outerHeight(),
													sent.value.spdX,
													sent.value.spdY,
													sent.value.size,
													sent.value.color);
		_ball.setRect($('#Body').outerWidth(),$('#Body').outerHeight());
		$('#Ball'+ball_list.length).css({
			'left':_ball.posX+'px',
			'top':_ball.posY+'px',
			'width':_ball.size+'px',
			'height':_ball.size+'px',
			'background-color': _ball.color
		});
		_ball.start();
		ball_list.push(_ball);
	}
});
</script>
{% endif %}
